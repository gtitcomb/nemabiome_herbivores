---
title: "Sample_Summary_Nematodes"
author: "Georgia Titcomb"
date: "April 3, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(sjPlot)
```

### Introduction

This document simply describes the samples tested, the prevalence of nematodes, and a comparison of methods.

#### 1. Overall prevalence

```{r}


samples = read_excel("SAMPLE_SUMMARY.xlsx", sheet="Sheet1")
head(samples)

```

#### Visualize overall prevalence by species

This prevalence is calculated based on all tests conducted -- from the first round of sequencing through post-filtering second round. It also incorporates qpcr prevalence (when not sequenced).

Specifically, the process was as follows:

1. Randomly select samples to sequence for round 1.

2. Choose all positive samples from round 1, a handful of negatives, and then a random selection of more samples for qpcr.

3. If qpcr CT values were <35, choose samples for sequencing. There were a few exceptions here, in which some samples had CT values <35 and were not chosen because sample size was already adequate, and some samples had CT values >35 and we were curious to see if they would show up from sequencing anyway.

4. Conduct filtering to determine presence/absence of any parasite DNA. In general, it turned out that after a granulary analysis of the distribution of reads for each MOTU across all ~100 blanks, the threshold ended up being ~ >100 reads.

5. Decision making for presence/absence was based on 1) If there was sequencing data, this was the priority (i.e., if a sample showed up positive with qpcr and negative with sequencing, then for the purposes of the following graph, it was considered negative). 2) If there was not sequencing data, then prevalence was determined first by qpcr and then by prior round sequencing results. For the most part, these were zeros.

```{r}
`%nin%` = Negate(`%in%`)
samp_filt = samples %>% filter(Species %nin% c("PCRC","Oribi","EC","NTC","Blank","PositiveControl"))

samp_summary = samp_filt %>% group_by(Species) %>% summarize_at(vars(overall_prev), funs(positive=sum(.,na.rm=T),tested=n()))

samp_summary$prevalence = samp_summary$positive/samp_summary$tested
head(samp_summary)

ggplot(samp_summary, aes(x=reorder(Species,-prevalence), y=prevalence))+
  geom_col(aes(fill=Species))+
  geom_text(aes(label=positive), nudge_y=0.03, size=3)+
  guides(fill=F)+
  labs(x="Species",y="Prevalence",title="Prevalence (numbers reflect total positive)")+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0))+
  scale_fill_sjplot(palette="aqua")


```


#### Prevalence in any screen

Here, a sample is considered positive if it tested positive using any method.

```{r}

samp_filt
samp_filt$any_yes = ifelse(samp_filt$rd_1_present=="Y",1, ifelse(samp_filt$rd_2_qpcr_present =="Y",1,ifelse(samp_filt$rd2_present =="Y",1,0)))

samp_summary2 = samp_filt %>% group_by(Species) %>% summarize_at(vars(any_yes), funs(positive=sum(.,na.rm=T),tested=n()))

samp_summary2$prevalence = samp_summary$positive/samp_summary$tested
head(samp_summary2)

ggplot(samp_summary2, aes(x=reorder(Species,-prevalence), y=prevalence))+
  geom_col(aes(fill=Species))+
  geom_text(aes(label=positive), nudge_y=0.03, size=3)+
  guides(fill=F)+
  labs(x="Species",y="Prevalence",title="Prevalence (numbers reflect total positive")+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0))+
  scale_fill_sjplot(palette="aqua")

```

```{r}

sum(samp_summary2$positive)-sum(samp_summary$positive)
samp_summary2$difference = samp_summary2$positive-samp_summary$positive
samp_summary2$pct_diff = samp_summary2$difference/samp_summary2$tested*100

ggplot(samp_summary2, aes(x=reorder(Species,-prevalence), y=pct_diff))+
  geom_col(aes(fill=Species))+
  geom_text(aes(label=tested), nudge_y=1, size=3)+
  guides(fill=F)+
  labs(x="Species",y="Percent Change",title="Difference between prevalence measures (numbers reflect total tested)")+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0))+
  scale_fill_sjplot(palette="aqua")
```



#### 2. Comparing qPCR results to reads

Given that qPCR can give some indication of the quantity of DNA in a sample, we could visualize to see if there is any relationship between qPCR CT values and total reads. However, if sample concentrations were balanced effectively to enable sequencing of equal quantity of DNA, there may be no relationship.

One thing that I did find from the first round was that some of the samples with highest DNA concentration from fluoresence test did not come back with any reads. It might be possible that the extremely small volume of PCR product required led to pipetting errors.

```{r}

head(samp_filt)

str(samp_filt)
samp_filt$rd_2_qpcr_mean_ct=as.numeric(samp_filt$rd_2_qpcr_mean_ct)
samp_filt$rd_total_reads_2=as.numeric(samp_filt$rd_total_reads_2)

ggplot(samp_filt, aes(x=rd_2_qpcr_mean_ct, y=log(rd_total_reads_2+1)))+
  geom_point()+
  geom_smooth()


samp_filt$seq2_present = ifelse(samp_filt$rd2_present=="Y",1,ifelse(samp_filt$rd2_present=="N",0,NA))

ggplot(samp_filt, aes(x=rd_2_qpcr_mean_ct, y=seq2_present))+
  geom_point(shape="|")+
  geom_smooth(method="glm", method.args=list(family="binomial"))+
  geom_vline(xintercept=35)+
  theme_bw()
```
