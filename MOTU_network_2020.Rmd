---
title: "MOTU_networks"
author: "Georgia Titcomb"
date: "May 1, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(igraph)
library(tidyverse)
library(ggthemr)

```

### Introduction

Analyses answering the following questions:

1. Which animals share parasites with each other?
2. What are the overall network properties?
3. Which animals are most important in this network?
a) Degree
b) Closeness Centrality
c) Betweenness

4. Comparison to networks constructed from the literature (and after Walker 2017).
5. Can edges be predicted based on phylogeny?


### Setup

I will use the full dataset from MOTU analyses

```{r}
# Read in data
motus = read.csv("RRAtab_filt2.csv")
head(motus)

motuinfo = read.delim("nematodes_2018_assembled_setid_filterE2_nl_uniq_c10_ann_assignEMBL_nematoda_sumatra_sumaclust_assignedR134.tab")
motu98 = data.frame(OTU = paste("MOTU_",motuinfo$cluster_sumatra98,sep=""), rank=motuinfo$rank_ok, sp=motuinfo$scientific_name_ok)


hosts = readxl::read_excel("SAMPLE_SUMMARY.xlsx",sheet="Sheet1")
head(hosts)

motu2 = left_join(hosts, motus, by=c("Sample_ID"="Sample_ID"))
names(motu2)
dim(motu2)
motu2 = motu2[which(motu2$rd2_sequenced=="Y"),]
motu2 = motu2[which(motu2$Location == "Mpala"),]

# include 
motu3 = motu2 %>% mutate_at(vars(MOTU_1:MOTU_557),funs(ifelse(is.na(.),0,.)))
#subtract 2 duplicates
which(duplicated(motu3$Sample_ID)==T)
#motu3 = motu3[-c(828,829),]
motu4 = motu3[-322,c(1,3,16:190)]

#long form
motu5 = motu4 %>% gather(MOTU_1:MOTU_557,key=MOTU, value=RRA)
motu5
motu5=motu5[,c(1,3,4,2)]
#remove 0s
motu5=motu5[-which(motu5$RRA==0),]

network <- graph_from_data_frame(motu5,directed=F)

namevec = V(network)$name
motucolrs = data.frame(Sample_ID=namevec[258:382], Species=rep("MOTU",125), Color=rep("gray50",125))

# Generate colors based on host type:
colrs = c("darkorchid2", "gold2", "darkorchid", "dodgerblue", "maroon1", "deepskyblue2", "green3", "gold", "lightskyblue", "maroon3", "lightsteelblue1", "greenyellow", "maroon", "dodgerblue3", "cadetblue1", "deepskyblue3", "hotpink1", "green4", "lightsteelblue3")

colr_sp = data.frame(Species = levels(as.factor(motu5$Species)), Color=colrs)
colr_match = left_join(motu5[,c(1,4)],colr_sp)
colr_match=rbind(colr_match, motucolrs)

colr_match = unique(colr_match)
dim(colr_match)
length(namevec)

V(network)$color=colr_match$Color
V(network)$label.cex=0.1
V(network)$frame.color=NA
V(network)$label.dist=2
V(network)$type = c(rep("TRUE",257),rep("FALSE",125))
V(network)$size=3
edge.start <- ends(network, es=E(network), names=F)[,1]
edge.col <- V(network)$color[edge.start]

E(network)$color = edge.col
E(network)$width=0.0001

plot(network,layout=layout_as_bipartite, vertex.color=colr_match$Color)
# HORRIBLE, now moving on
```

This looks terrible, so I will use projected df

```{r}

head(motu4)
motu_avg = motu4 %>% group_by(Species) %>% summarize_at(vars(MOTU_1:MOTU_557), funs(mean))
motu_avg2 = motu_avg %>% gather(MOTU_1:MOTU_557,key=MOTU, value=RRA)


motu_avg2=motu_avg2[-which(motu_avg2$RRA==0),]

network = graph_from_data_frame(motu_avg2,directed=F)

namevec = V(network)$name
motucolrs = data.frame(Species=namevec[20:144], Color=rep("gray50",125))

# Generate colors based on host type:
colrs2 = c("darkorchid2","dodgerblue","green3","gold","lightsteelblue1","dodgerblue3","deepskyblue3","cadetblue1","deepskyblue2","lightsteelblue3","green4","darkorchid", "gold2", "lightskyblue",  "maroon1", "maroon3",  "greenyellow","maroon", "hotpink1")


colr_sp = data.frame(Species =namevec[1:19], Color=colrs2)
colr_match=rbind(colr_sp, motucolrs)

colr_match = unique(colr_match)
dim(colr_match)
length(namevec)

V(network)$color=colr_match$Color
V(network)$label.cex=1
#V(network)$label=c(V(network)$name[1:19],rep("",165))
V(network)$label=V(network)$name
V(network)$frame.color=NA
V(network)$label.dist=0
V(network)$label.family="sans serif"
V(network)$type = c(rep("TRUE",19),rep("FALSE",125))
V(network)$size=3
edge.start <- ends(network, es=E(network), names=F)[,1]
edge.col <- V(network)$color[edge.start]
E(network)$weight = motu_avg2$RRA
E(network)$color = edge.col
E(network)$width=E(network)$weight*50

LO = layout_as_bipartite(network)
plot(network,vertex.color=colr_match$Color,layout=LO[,2:1])

#plot(network, vertex.color=colr_match$Color,vertex.label="",layout=layout_nicely)


# projected nw
network3 = bipartite.projection(network)
plot(network3$proj2, vertex.size=10,layout=layout_nicely)


```

```{r}

# Making this in ggplot

head(motu_avg2)
dat=motu_avg2[-c(233:234),]
rangeTransform = function(x) (x - min(x)) / (max(x) - min(x))
dat$Species = factor(dat$Species, levels=c("Donkey","Plains zebra", "Grevys zebra","Hybrid zebra","Hippo","Warthog","Eland","Buffalo","Cattle","Kudu","Impala","Hartebeest","Grants gazelle","Oryx","DikDik","Giraffe","Camel","Waterbuck","Elephant"))

# reorder the MOTUs to make sense (based on layout_as_bipartite results)
motuorder = c("MOTU_82","MOTU_91","MOTU_172","MOTU_177","MOTU_62","MOTU_92","MOTU_19","MOTU_39","MOTU_43","MOTU_94","MOTU_70","MOTU_194","MOTU_57","MOTU_72","MOTU_36","MOTU_45","MOTU_49","MOTU_149","MOTU_50","MOTU_24","MOTU_173","MOTU_46","MOTU_34","MOTU_63","MOTU_31","MOTU_11","MOTU_101","MOTU_28","MOTU_51","MOTU_7","MOTU_20","MOTU_114","MOTU_491","MOTU_110","MOTU_22","MOTU_6","MOTU_288","MOTU_87","MOTU_124","MOTU_229","MOTU_126","MOTU_109","MOTU_157","MOTU_2","MOTU_9","MOTU_246","MOTU_136","MOTU_209","MOTU_164","MOTU_303","MOTU_15","MOTU_129","MOTU_216","MOTU_53","MOTU_88","MOTU_163","MOTU_32","MOTU_37","MOTU_423","MOTU_211","MOTU_100","MOTU_79","MOTU_30","MOTU_260","MOTU_461","MOTU_146","MOTU_192","MOTU_48","MOTU_4","MOTU_68","MOTU_78","MOTU_85","MOTU_64","MOTU_52","MOTU_61","MOTU_1","MOTU_16","MOTU_10","MOTU_123","MOTU_56","MOTU_13","MOTU_5","MOTU_17","MOTU_33","MOTU_67","MOTU_162","MOTU_35","MOTU_14","MOTU_25","MOTU_112","MOTU_292","MOTU_83","MOTU_144","MOTU_47","MOTU_75","MOTU_42","MOTU_29","MOTU_40","MOTU_86","MOTU_54","MOTU_287","MOTU_38","MOTU_334","MOTU_103","MOTU_81","MOTU_18","MOTU_8","MOTU_89","MOTU_55","MOTU_59","MOTU_121","MOTU_60","MOTU_23","MOTU_12","MOTU_84","MOTU_71","MOTU_27","MOTU_76","MOTU_135","MOTU_21","MOTU_102","MOTU_26","MOTU_41","MOTU_44","MOTU_90")

length(levels(as.factor(dat$MOTU)))
dat$MOTU=factor(dat$MOTU, levels=motuorder)

dat$x1_norm = rangeTransform(as.integer(dat$Species))
dat$x2_norm = rangeTransform(as.integer(dat$MOTU))


dat$y1 = 0
dat$y2 = 1

# make a color vector based on the species levels
levels(dat$Species)
colrplot = c("#CD00CD", "#FF34B3", "#CD2990", "#8B1C62", "#ADFF2F", "#008B00", "#8470FF", "#68228B", "#9A32CD", "#1E90FF", "#1874CD", "#104E8B", "#87CEFA", "#00BFFF", "#A4D3EE", "#EEC900", "#CDAD00", "#98F5FF", "#00CD00")
  
  
ggplot(dat, aes(x=x1_norm, xend=x2_norm, y=y1, yend=y2, color=Species))+
  geom_segment()+
  #theme(axis.text.x=element_text(angle=90,hjust=1,vjust=-1))+
  scale_color_manual(values=colrplot)+
  annotate("text", y=-.1, x=as.numeric(levels(as.factor(dat$x1_norm))), label=levels(dat$Species))+
  coord_flip()+
  scale_y_continuous(limits=c(-0.2,1))+
  guides(color=F)+
  theme_void()


```


### 1. Which animals share parasites with one another?

```{r}

library(bipartite)

# need to get motu avg into this format
motuavg = motu_avg[,-1]

matches = unique(left_join(data.frame(OTU = names(motuavg)),motu98, by=("OTU"="OTU")))
matches=(matches[-which(duplicated(matches$OTU)),])
matches$sp2 = paste(abbreviate(matches$sp),seq(1,175),sep="")

names(motuavg) = matches$sp2

# make 0/1 matrix
motuavg1 = motuavg %>% as.tibble() %>% mutate_at(vars(Copr1:Osph175), funs(ifelse(.>0.01,1,0))) %>% as.matrix()

rownames(motuavg1) = rownames(motuavg)
rownames(motuavg) = motu_avg$Species
motuavg = as.matrix(motuavg)
plotweb(motuavg)
plotweb(motuavg1)

# The answer doesn't appear to be very stable
mod = computeModules(motuavg)
mod1 = computeModules(motuavg1,steps=1000) # extra steps 

plotModuleWeb(mod)
plotModuleWeb(mod1) # binary
```

## 2. Network properties


```{r}

nl = networklevel(motuavg)
nl1 = networklevel(motuavg1)

nl;nl1

```


## Using another method

```{r}

lit = read.csv("host_parasite_lit.csv")

# format literature network
lit_simple = lit[,c(1,6,8)]

hist(lit_simple$Refs)
lit_simple %>% group_by(Host) %>% summarize_at(vars(Refs), funs(sum))

# Refs could be a metric of sampling effort
lit_simple2=lit_simple %>% group_by(Host, Species_clean)%>% summarize_at(vars(Refs), funs(sum))

lit_wide=lit_simple2 %>% spread(key=Species_clean, value=Refs,fill=0)


litR = rrarefy(lit_wide[,-1], 28) # why 28
litR2 = as.data.frame(litR)
litR2$Host=lit_wide$Host
litR2
litR3 = litR2 %>% gather(key=Species_clean, value=Refs, -Host)
# remove 0s
litR4=litR3[-which(litR3$Refs==0),]
lit_net <- graph.data.frame(lit_simple, directed=FALSE)
lit_net <- graph.data.frame(litR4, directed=FALSE)

V(lit_net)$type = c(rep("TRUE",15),rep("FALSE",159))
#V(lit_net)$types = c(rep("TRUE",15),rep("FALSE",160))
V(lit_net)$frame.color=NA
V(lit_net)$label.dist=0
V(lit_net)$label.family="sans serif"
V(lit_net)$label=c("Hartebeest","Oryx","Buffalo","Cattle","Elephant","Giraffe","Camel","Impala","Warthog","Eland","Grants gazelle","Plains zebra","Donkey","Grevys zebra","DikDik",V(lit_net)$name[16:166])

network4 = bipartite.projection(lit_net)
plot(network4$proj2, vertex.size=10,layout=layout_nicely)


motu_counts = motu4 %>% mutate_at(vars(MOTU_1:MOTU_557), funs(ifelse(.>0,1,0))) %>% group_by(Species) %>% summarize_at(vars(MOTU_1:MOTU_557),funs(sum))
head(motu_counts)
# exclude species not from lit review
motu_counts=motu_counts[-which(motu_counts$Species %in% c("Kudu","Waterbuck","Hybrid zebra","Hippo")),]

motu_count_r = rrarefy(motu_counts[,-1],28) # same number as studies, but should experiment with changing this
rowSums(motu_counts[,-1])
motuR2 = as.data.frame(motu_count_r)
motuR2$Host=motu_counts$Species
motuR3 = motuR2 %>% gather(key=Species, value=Count,-Host)

# remove 0s
motuR4=motuR3[-which(motuR3$Count==0),]
motuR_net = graph.data.frame(motuR4, directed=FALSE)

bet_motu = igraph::betweenness(motuR_net)
bet_lit = igraph::betweenness(lit_net)

#bet_hosts =bet_motu[c(1:7,9:15,18:19)]
bet_hosts = bet_motu[1:15]
bet_lit_hosts = bet_lit[1:15]

names(bet_lit_hosts) =c("Hartebeest","Oryx","Buffalo","Cattle","Eland","Giraffe","Impala","Camel","Grants gazelle","Plains zebra","Donkey","Grevys zebra","Warthog","Elephant","DikDik")
bet_lit_hosts
bet_hosts
bet_motu=bet_motu[match(names(bet_lit_hosts),names(bet_hosts))]
bet_comp = data.frame(MOTU_B = bet_motu, LIT_B=bet_lit_hosts, SP = names(bet_lit_hosts))
ggplot(bet_comp, aes(x=MOTU_B, y=LIT_B))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)

cor.test(bet_comp$MOTU_B,bet_comp$LIT_B) # 


```


### Closeness

```{r}

close_motu = igraph::closeness(motuR_net)
close_lit = igraph::closeness(lit_net)

#bet_hosts =bet_motu[c(1:7,9:15,18:19)]
close_hosts = close_motu[1:15]
close_lit_hosts = close_lit[1:15]

names(close_lit_hosts) =c("Hartebeest","Oryx","Buffalo","Cattle","Eland","Giraffe","Impala","Camel","Grants gazelle","Plains zebra","Donkey","Grevys zebra","Warthog","Elephant","DikDik")
close_lit_hosts
close_hosts
close_motu=close_motu[match(names(close_lit_hosts),names(close_hosts))]
close_comp = data.frame(MOTU_C = close_motu, LIT_C=close_lit_hosts, SP = names(close_lit_hosts))
ggplot(close_comp, aes(x=MOTU_C, y=LIT_C))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)

ggplot(close_comp[-which(close_comp$SP=="Elephant"),], aes(x=MOTU_C, y=LIT_C))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)

cor.test(close_comp$MOTU_C,close_comp$LIT_C,method="spearman") # 
cor.test(close_comp[-which(close_comp$SP=="Elephant"),]$MOTU_C,close_comp[-which(close_comp$SP=="Elephant"),]$LIT_C,method="spearman") # no correlation when elephant taken away


```

# Degree

```{r}


degree_motu = igraph::degree(motuR_net)
degree_lit = igraph::degree(lit_net)

#bet_hosts =bet_motu[c(1:7,9:15,18:19)]
degree_hosts = degree_motu[1:15]
degree_lit_hosts = degree_lit[1:15]

names(degree_lit_hosts) =c("Hartebeest","Oryx","Buffalo","Cattle","Eland","Giraffe","Impala","Camel","Grants gazelle","Plains zebra","Donkey","Grevys zebra","Warthog","Elephant","DikDik")
degree_lit_hosts
degree_hosts
degree_motu=degree_motu[match(names(degree_lit_hosts),names(degree_hosts))]
degree_comp = data.frame(MOTU_C = degree_motu, LIT_C=degree_lit_hosts, SP = names(degree_lit_hosts))
ggplot(degree_comp, aes(x=MOTU_C, y=LIT_C))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)


cor.test(degree_comp$MOTU_C,degree_comp$LIT_C, method="spearman") #no correlation


```

# Eigencent

```{r}


eigen_motu = igraph::eigen_centrality(motuR_net)
eigen_lit = igraph::eigen_centrality(lit_net)

#bet_hosts =bet_motu[c(1:7,9:15,18:19)]
eigen_hosts = eigen_motu$vector[1:15]
eigen_lit_hosts = eigen_lit$vector[1:15]

names(eigen_lit_hosts) =c("Hartebeest","Oryx","Buffalo","Elephant","Cattle","Impala","Giraffe","Eland","Grants gazelle","Donkey","Plains zebra","Grevys zebra","Warthog","Camel","DikDik")
eigen_lit_hosts
eigen_hosts
eigen_motu=eigen_motu$vector[match(names(eigen_lit_hosts),names(eigen_hosts))]
eigen_comp = data.frame(MOTU_E = eigen_motu, LIT_E=eigen_lit_hosts, SP = names(eigen_lit_hosts))
ggplot(eigen_comp, aes(x=MOTU_E, y=LIT_E))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)


cor.test(eigen_comp$MOTU_E,eigen_comp$LIT_E, method="spearman") #correlation


```

## Nestedness

```{r}


lit_simple=lit_simple %>% group_by(Host, Species_clean) %>% summarize_at(vars(Refs),funs(sum))
lit_wide=lit_simple %>% spread(key=Species_clean, value=Refs,fill=0)

nestedbetajac(litR[,-1])
nestedchecker(litR[,-1])
oecosimu(litR[,-1], nestedchecker,"quasiswap")
oecosimu(litR[,-1], nestedchecker,"r00",statistic="C.score")

nestedbetajac(motu_count_r[,-1])
nestedchecker(motu_count_r[,-1])
oecosimu(motu_count_r[,-1], nestedchecker,"quasiswap")
oecosimu(motu_count_r[,-1], nestedchecker,"r00",statistic="C.score")




```


MOTU data and literature are inherently different. Arguably, MOTU data are better because we retain information at the individual level, and can thus scale up to the population and species level, as is often the unit of analysis for meta-analyses. 

Here, we compare important network indices for a community of 15 sympatric herbivore species from molecular data to indices for sharing derived from the literature. Take-aways: both networks showed nestedness, important for parasites because XXX. However, node-level indices were completely uncorrelated. In particular, literature networks appear to over-estimate domestic animals, even after rarefaction for sampling effort. 


I'd now like to see how robust MOTU networks are across sites

```{r}


motusites = left_join(hosts, motus, by=c("Sample_ID"="Sample_ID"))

motusites = motusites[which(motusites$rd2_sequenced=="Y"),]
# restrict to only six species of interest
motusites = motusites[which(motusites$Species %in% c("Plains zebra","Warthog","Buffalo","Kudu","Elephant","Impala")),]

# include 
motusites2= motusites %>% mutate_at(vars(MOTU_1:MOTU_557),funs(ifelse(is.na(.),0,.)))
#subtract 2 duplicates
which(duplicated(motusites2$Sample_ID)==T)
motusites3 = motusites2[-624,c(1,3,16:180)]


motusite_avg = motusites %>% group_by(Species,Location) %>% summarize_at(vars(MOTU_1:MOTU_557), funs(mean(.,na.rm=T)))
motu_siteavg2 = motusite_avg %>% gather(MOTU_1:MOTU_557,key=MOTU, value=RRA)
motu_siteavg2=motu_siteavg2[-which(motu_siteavg2$RRA==0),]

for(i in 1:length(levels(as.factor(motu_siteavg2$Location)))){
  net = graph_from_data_frame(motu_siteavg2[motu_siteavg2$Location==levels(as.factor(motu_siteavg2$Location))[i],-2],directed=F)
  plot(net)
}

jdists = list()
for(i in 1:length(levels(as.factor(motu_siteavg2$Location)))){
  df=spread(motu_siteavg2[motu_siteavg2$Location==levels(as.factor(motu_siteavg2$Location))[i],-2],key=MOTU,value=RRA,fill=0)
  rels = as.data.frame(distance(df[,-1],method="jaccard"))
  rownames(rels)=df$Species
  names(rels)=df$Species
  print(rels)
}

motu_siteavg2$sp_loc=paste(motu_siteavg2$Species,motu_siteavg2$Location,sep="_")
new_net = graph_from_data_frame(motu_siteavg2[,c(5,3,4,1,2)],directed=F)

#V(new_net)$label=c(V(new_net)$name[1:42],rep("",135))
V(new_net)$label=c("Gor","Hlu","Hwa","Kaf","Mpa","Nia","Ser","Nia","Gor","Hlu","Hwa","Kaf","Kru", "Mpa","Nia","Ser","Gor","Kru","Gor","Hlu","Mpa","Ser","Kaf","Nia","Nyi","Mpa","Hlu","Hwa","Kru",
                   "Mpa","Ser","Hlu","Hwa","Kaf","Mpa","Gor","Nia","Nyi","Hwa","Kaf","Nia","Nyi",rep("",135))
V(new_net)$type=c(rep("TRUE",42),rep("FALSE",135))
V(new_net)$size=ifelse(V(new_net)$type=="TRUE",8,3)
V(new_net)$color = c(rep("darkorchid1",7),rep("greenyellow",1),rep("dodgerblue",8),rep("cyan2",2),rep("green3",7),rep("cyan2",1),rep("deeppink2",5),rep("greenyellow",5),rep("deeppink2",2),rep("cyan2",3),rep("greenyellow",1),rep("gray70",135))
V(new_net)$frame.color=NA
V(new_net)$label.color="gray10"
V(new_net)$label.family="sans serif"
V(new_net)$label.dist=0

edge.start <- ends(new_net, es=E(new_net), names=F)[,1]
edge.col <- V(new_net)$color[edge.start]

LO=layout_as_bipartite(new_net)
plot(new_net,layout=layout_nicely)


```






# Using 99% data

### Setup

I will use the full dataset from MOTU analyses

```{r}
# Read in data
motus = read.csv("RRAtab_filt2_99.csv")
dim(motus)

motuinfo = read.delim("nematodes_2018_assembled_setid_filterE2_nl_uniq_c10_ann_assignEMBL_nematoda_sumatra_sumaclust_assignedR134.tab")
motu98 = data.frame(OTU = paste("MOTU_",motuinfo$cluster_sumatra99,sep=""), rank=motuinfo$rank_ok, sp=motuinfo$scientific_name_ok)


hosts = readxl::read_excel("SAMPLE_SUMMARY.xlsx",sheet="Sheet1")
head(hosts)

motu2 = left_join(hosts, motus, by=c("Sample_ID"="Sample_ID"))
names(motu2)
dim(motu2)
motu2 = motu2[which(motu2$rd2_sequenced=="Y"),]
motu2 = motu2[which(motu2$Location == "Mpala"),]

# include 
motu3 = motu2 %>% mutate_at(vars(MOTU_1:MOTU_1677),funs(ifelse(is.na(.),0,.)))
#subtract 2 duplicates
which(duplicated(motu3$Sample_ID)==T)
#motu3 = motu3[-c(828,829),]
motu4 = motu3[-322,c(1,3,16:502)]

#long form
motu5 = motu4 %>% gather(MOTU_1:MOTU_1677,key=MOTU, value=RRA)
motu5
motu5=motu5[,c(1,3,4,2)]
#remove 0s
motu5=motu5[-which(motu5$RRA==0),]

network <- graph_from_data_frame(motu5,directed=F)

namevec = V(network)$name
motucolrs = data.frame(Sample_ID=namevec[265:561], Species=rep("MOTU",297), Color=rep("gray50",297))

# Generate colors based on host type:
colrs = c("darkorchid2", "gold2", "darkorchid", "dodgerblue", "maroon1", "deepskyblue2", "green3", "gold", "lightskyblue", "maroon3", "lightsteelblue1", "greenyellow", "maroon", "dodgerblue3", "cadetblue1", "deepskyblue3", "hotpink1", "green4", "lightsteelblue3")

colr_sp = data.frame(Species = levels(as.factor(motu5$Species)), Color=colrs)
colr_match = left_join(motu5[,c(1,4)],colr_sp)
colr_match=rbind(colr_match, motucolrs)

colr_match = unique(colr_match)
dim(colr_match)
length(namevec)

V(network)$color=colr_match$Color
V(network)$label.cex=0.1
V(network)$frame.color=NA
V(network)$label.dist=2
V(network)$type = c(rep("TRUE",264),rep("FALSE",297))
V(network)$size=3
edge.start <- ends(network, es=E(network), names=F)[,1]
edge.col <- V(network)$color[edge.start]

E(network)$color = edge.col
E(network)$width=0.0001

plot(network,layout=layout_as_bipartite, vertex.color=colr_match$Color)
# HORRIBLE, now moving on
```

This looks terrible, so I will use projected df

```{r}

head(motu4)
motu_avg = motu4 %>% group_by(Species) %>% summarize_at(vars(MOTU_1:MOTU_1677), funs(mean))
motu_avg2 = motu_avg %>% gather(MOTU_1:MOTU_1677,key=MOTU, value=RRA)


motu_avg2=motu_avg2[-which(motu_avg2$RRA==0),]

network = graph_from_data_frame(motu_avg2,directed=F)

namevec = V(network)$name
motucolrs = data.frame(Species=namevec[20:316], Color=rep("gray50",297))

# Generate colors based on host type:
colrs2 = c("darkorchid2","dodgerblue","green3","gold","lightsteelblue1","dodgerblue3","deepskyblue3","cadetblue1","deepskyblue2","lightsteelblue3","green4","darkorchid", "gold2", "lightskyblue",  "maroon1", "maroon3",  "greenyellow","maroon", "hotpink1")


colr_sp = data.frame(Species =namevec[1:19], Color=colrs2)
colr_match=rbind(colr_sp, motucolrs)

colr_match = unique(colr_match)
dim(colr_match)
length(namevec)

V(network)$color=colr_match$Color
V(network)$label.cex=1
#V(network)$label=c(V(network)$name[1:19],rep("",165))
V(network)$label=V(network)$name
V(network)$frame.color=NA
V(network)$label.dist=0
V(network)$label.family="sans serif"
V(network)$type = c(rep("TRUE",19),rep("FALSE",297))
V(network)$size=3
edge.start <- ends(network, es=E(network), names=F)[,1]
edge.col <- V(network)$color[edge.start]
E(network)$weight = motu_avg2$RRA
E(network)$color = edge.col
E(network)$width=E(network)$weight*50

LO = layout_as_bipartite(network)
plot(network,vertex.color=colr_match$Color,layout=LO[,2:1])


projnets = bipartite.projection(network)
plot(projnets$proj2, vertex.size=10,layout=layout_nicely)

```

```{r}

# Making this in ggplot -- have not done this for 99 data

head(motu_avg2)
dat=motu_avg2[-c(233:234),]
rangeTransform = function(x) (x - min(x)) / (max(x) - min(x))
dat$Species = factor(dat$Species, levels=c("Donkey","Plains zebra", "Grevys zebra","Hybrid zebra","Hippo","Warthog","Eland","Buffalo","Cattle","Kudu","Impala","Hartebeest","Grants gazelle","Oryx","DikDik","Giraffe","Camel","Waterbuck","Elephant"))

# reorder the MOTUs to make sense (based on layout_as_bipartite results)
motuorder = c("MOTU_82","MOTU_91","MOTU_172","MOTU_177","MOTU_62","MOTU_92","MOTU_19","MOTU_39","MOTU_43","MOTU_94","MOTU_70","MOTU_194","MOTU_57","MOTU_72","MOTU_36","MOTU_45","MOTU_49","MOTU_149","MOTU_50","MOTU_24","MOTU_173","MOTU_46","MOTU_34","MOTU_63","MOTU_31","MOTU_11","MOTU_101","MOTU_28","MOTU_51","MOTU_7","MOTU_20","MOTU_114","MOTU_491","MOTU_110","MOTU_22","MOTU_6","MOTU_288","MOTU_87","MOTU_124","MOTU_229","MOTU_126","MOTU_109","MOTU_157","MOTU_2","MOTU_9","MOTU_246","MOTU_136","MOTU_209","MOTU_164","MOTU_303","MOTU_15","MOTU_129","MOTU_216","MOTU_53","MOTU_88","MOTU_163","MOTU_32","MOTU_37","MOTU_423","MOTU_211","MOTU_100","MOTU_79","MOTU_30","MOTU_260","MOTU_461","MOTU_146","MOTU_192","MOTU_48","MOTU_4","MOTU_68","MOTU_78","MOTU_85","MOTU_64","MOTU_52","MOTU_61","MOTU_1","MOTU_16","MOTU_10","MOTU_123","MOTU_56","MOTU_13","MOTU_5","MOTU_17","MOTU_33","MOTU_67","MOTU_162","MOTU_35","MOTU_14","MOTU_25","MOTU_112","MOTU_292","MOTU_83","MOTU_144","MOTU_47","MOTU_75","MOTU_42","MOTU_29","MOTU_40","MOTU_86","MOTU_54","MOTU_287","MOTU_38","MOTU_334","MOTU_103","MOTU_81","MOTU_18","MOTU_8","MOTU_89","MOTU_55","MOTU_59","MOTU_121","MOTU_60","MOTU_23","MOTU_12","MOTU_84","MOTU_71","MOTU_27","MOTU_76","MOTU_135","MOTU_21","MOTU_102","MOTU_26","MOTU_41","MOTU_44","MOTU_90")

length(levels(as.factor(dat$MOTU)))
dat$MOTU=factor(dat$MOTU, levels=motuorder)

dat$x1_norm = rangeTransform(as.integer(dat$Species))
dat$x2_norm = rangeTransform(as.integer(dat$MOTU))


dat$y1 = 0
dat$y2 = 1

# make a color vector based on the species levels
levels(dat$Species)
colrplot = c("#CD00CD", "#FF34B3", "#CD2990", "#8B1C62", "#ADFF2F", "#008B00", "#8470FF", "#68228B", "#9A32CD", "#1E90FF", "#1874CD", "#104E8B", "#87CEFA", "#00BFFF", "#A4D3EE", "#EEC900", "#CDAD00", "#98F5FF", "#00CD00")
  
  
ggplot(dat, aes(x=x1_norm, xend=x2_norm, y=y1, yend=y2, color=Species))+
  geom_segment()+
  #theme(axis.text.x=element_text(angle=90,hjust=1,vjust=-1))+
  scale_color_manual(values=colrplot)+
  annotate("text", y=-.1, x=as.numeric(levels(as.factor(dat$x1_norm))), label=levels(dat$Species))+
  coord_flip()+
  scale_y_continuous(limits=c(-0.2,1))+
  guides(color=F)+
  theme_void()


```


### 1. Which animals share parasites with one another?

```{r}

library(bipartite)

# need to get motu avg into this format
motuavg = motu_avg[,-1]

matches = unique(left_join(data.frame(OTU = names(motuavg)),motu98, by=("OTU"="OTU")))
matches=(matches[-which(duplicated(matches$OTU)),])
matches$sp2 = paste(abbreviate(matches$sp),seq(1,487),sep="")

names(motuavg) = matches$sp2

# make 0/1 matrix
motuavg1 = motuavg %>% as.tibble() %>% mutate_at(vars(Strongylid1:Osph190), funs(ifelse(.>0.01,1,0))) %>% as.matrix()

rownames(motuavg1) = rownames(motuavg)
rownames(motuavg) = motu_avg$Species
rownames(motuavg1) = rownames(motuavg)

motuavg = as.matrix(motuavg)
plotweb(motuavg)
plotweb(motuavg1)

# The answer doesn't appear to be very stable
mod = computeModules(motuavg)
mod1 = computeModules(motuavg1,steps=1000) # extra steps 

plotModuleWeb(mod)
plotModuleWeb(mod1) # binary
```

## 2. Network properties


```{r}

nl = networklevel(motuavg)
nl1 = networklevel(motuavg1)

nl;nl1

```


## Using another method

```{r}

lit = read.csv("host_parasite_lit.csv")

# format literature network
lit_simple = lit[,c(1,6,8)]

hist(lit_simple$Refs)
lit_simple %>% group_by(Host) %>% summarize_at(vars(Refs), funs(sum))

# Refs could be a metric of sampling effort
lit_simple2=lit_simple %>% group_by(Host, Species_clean)%>% summarize_at(vars(Refs), funs(sum))

lit_wide=lit_simple2 %>% spread(key=Species_clean, value=Refs,fill=0)

litR = rrarefy(lit_wide[,-1], 28) # why 28
litR2 = as.data.frame(litR)
litR2$Host=lit_wide$Host
litR2
litR3 = litR2 %>% gather(key=Species_clean, value=Refs, -Host)
# remove 0s
litR4=litR3[-which(litR3$Refs==0),]
lit_net <- graph.data.frame(lit_simple, directed=FALSE)
lit_net <- graph.data.frame(litR4, directed=FALSE)



motu_counts = motu4 %>% mutate_at(vars(MOTU_1:MOTU_1677), funs(ifelse(.>0,1,0))) %>% group_by(Species) %>% summarize_at(vars(MOTU_1:MOTU_1677),funs(sum))
head(motu_counts)
# exclude species not from lit review
motu_counts=motu_counts[-which(motu_counts$Species %in% c("Kudu","Waterbuck","Hybrid zebra","Hippo")),]

motu_count_r = rrarefy(motu_counts[,-1],28) # same number as studies, but should experiment with changing this
rowSums(motu_counts[,-1])
motuR2 = as.data.frame(motu_count_r)
motuR2$Host=motu_counts$Species
motuR3 = motuR2 %>% gather(key=Species, value=Count,-Host)

# remove 0s
motuR4=motuR3[-which(motuR3$Count==0),]
motuR_net = graph.data.frame(motuR4, directed=FALSE)

bet_motu = igraph::betweenness(motuR_net)
bet_lit = igraph::betweenness(lit_net)

#bet_hosts =bet_motu[c(1:7,9:15,18:19)]
bet_hosts = bet_motu[1:15]
bet_lit_hosts = bet_lit[1:15]

names(bet_lit_hosts) =c("Hartebeest","Oryx","Buffalo","Elephant","Cattle","Impala","Giraffe","Eland","Grants gazelle","Donkey","Plains zebra","Grevys zebra","Warthog","Camel","DikDik")
bet_lit_hosts
bet_hosts
bet_motu=bet_motu[match(names(bet_lit_hosts),names(bet_hosts))]
bet_comp = data.frame(MOTU_B = bet_motu, LIT_B=bet_lit_hosts, SP = names(bet_lit_hosts))
ggplot(bet_comp, aes(x=MOTU_B, y=LIT_B))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)

cor.test(bet_comp$MOTU_B,bet_comp$LIT_B) # 


```


### Closeness

```{r}

close_motu = igraph::closeness(motuR_net)
close_lit = igraph::closeness(lit_net)

#bet_hosts =bet_motu[c(1:7,9:15,18:19)]
close_hosts = close_motu[1:15]
close_lit_hosts = close_lit[1:15]

names(close_lit_hosts) =c("Hartebeest","Oryx","Buffalo","Elephant","Cattle","Impala","Giraffe","Eland","Grants gazelle","Donkey","Plains zebra","Grevys zebra","Warthog","Camel","DikDik")
close_lit_hosts
close_hosts
close_motu=close_motu[match(names(close_lit_hosts),names(close_hosts))]
close_comp = data.frame(MOTU_C = close_motu, LIT_C=close_lit_hosts, SP = names(close_lit_hosts))
ggplot(close_comp, aes(x=MOTU_C, y=LIT_C))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)

ggplot(close_comp[-which(close_comp$SP=="Elephant"|close_comp$SP=="Warthog"),], aes(x=MOTU_C, y=LIT_C))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)

cor.test(close_comp$MOTU_C,close_comp$LIT_C,method="spearman") # 
cor.test(close_comp[-which(close_comp$SP=="Elephant"),]$MOTU_C,close_comp[-which(close_comp$SP=="Elephant"),]$LIT_C,method="spearman") # no correlation when elephant taken away


```

# Degree

```{r}


degree_motu = igraph::degree(motuR_net)
degree_lit = igraph::degree(lit_net)

#bet_hosts =bet_motu[c(1:7,9:15,18:19)]
degree_hosts = degree_motu[1:15]
degree_lit_hosts = degree_lit[1:15]

names(degree_lit_hosts) =c("Hartebeest","Oryx","Buffalo","Elephant","Cattle","Impala","Giraffe","Eland","Grants gazelle","Donkey","Plains zebra","Grevys zebra","Warthog","Camel","DikDik")
degree_lit_hosts
degree_hosts
degree_motu=degree_motu[match(names(degree_lit_hosts),names(degree_hosts))]
degree_comp = data.frame(MOTU_D = degree_motu, LIT_D=degree_lit_hosts, SP = names(degree_lit_hosts))
ggplot(degree_comp, aes(x=MOTU_D, y=LIT_D))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)


cor.test(degree_comp$MOTU_C,degree_comp$LIT_C, method="spearman") #no correlation


```
# Eigencent

```{r}


eigen_motu = igraph::eigen_centrality(motuR_net)
eigen_lit = igraph::eigen_centrality(lit_net)

#bet_hosts =bet_motu[c(1:7,9:15,18:19)]
eigen_hosts = eigen_motu$vector[1:15]
eigen_lit_hosts = eigen_lit$vector[1:15]

names(eigen_lit_hosts) =c("Hartebeest","Oryx","Buffalo","Elephant","Cattle","Impala","Giraffe","Eland","Grants gazelle","Donkey","Plains zebra","Grevys zebra","Warthog","Camel","DikDik")
eigen_lit_hosts
eigen_hosts
eigen_motu=eigen_motu$vector[match(names(eigen_lit_hosts),names(eigen_hosts))]
eigen_comp = data.frame(MOTU_E = eigen_motu, LIT_E=eigen_lit_hosts, SP = names(eigen_lit_hosts))
ggplot(eigen_comp, aes(x=MOTU_E, y=LIT_E))+
  geom_point()+
  geom_text(aes(label=SP))+
  geom_abline(slope=1, intercept=0)


cor.test(eigen_comp$MOTU_E,eigen_comp$LIT_E, method="spearman") #correlation


```




## Nestedness

```{r}


lit_simple=lit_simple %>% group_by(Host, Species_clean) %>% summarize_at(vars(Refs),funs(sum))
lit_wide=lit_simple %>% spread(key=Species_clean, value=Refs,fill=0)

nestedbetajac(litR[,-1])
nestedchecker(litR[,-1])
oecosimu(litR[,-1], nestedchecker,"quasiswap")
oecosimu(litR[,-1], nestedchecker,"r00",statistic="C.score")

nestedbetajac(motu_count_r[,-1])
nestedchecker(motu_count_r[,-1])
oecosimu(motu_count_r[,-1], nestedchecker,"quasiswap")
oecosimu(motu_count_r[,-1], nestedchecker,"r00",statistic="C.score")




```


MOTU data and literature are inherently different. Arguably, MOTU data are better because we retain information at the individual level, and can thus scale up to the population and species level, as is often the unit of analysis for meta-analyses. 

Here, we compare important network indices for a community of 15 sympatric herbivore species from molecular data to indices for sharing derived from the literature. Take-aways: both networks showed nestedness, important for parasites because XXX. However, node-level indices were completely uncorrelated. In particular, literature networks appear to over-estimate domestic animals, even after rarefaction for sampling effort. 


I'd now like to see how robust MOTU networks are across sites

```{r}


motusites = left_join(hosts, motus, by=c("Sample_ID"="Sample_ID"))

motusites = motusites[which(motusites$rd2_sequenced=="Y"),]
# restrict to only six species of interest
motusites = motusites[which(motusites$Species %in% c("Plains zebra","Warthog","Buffalo","Kudu","Elephant","Impala")),]

# include 
motusites2= motusites %>% mutate_at(vars(MOTU_1:MOTU_1677),funs(ifelse(is.na(.),0,.)))
#subtract 2 duplicates
which(duplicated(motusites2$Sample_ID)==T)
motusites3 = motusites2[-624,c(1,3,16:505)]


motusite_avg = motusites %>% group_by(Species,Location) %>% summarize_at(vars(MOTU_1:MOTU_1677), funs(mean(.,na.rm=T)))
motu_siteavg2 = motusite_avg %>% gather(MOTU_1:MOTU_1677,key=MOTU, value=RRA)
motu_siteavg2=motu_siteavg2[-which(motu_siteavg2$RRA==0),]

for(i in 1:length(levels(as.factor(motu_siteavg2$Location)))){
  net = graph_from_data_frame(motu_siteavg2[motu_siteavg2$Location==levels(as.factor(motu_siteavg2$Location))[i],-2],directed=F)
  plot(net)
}

jdists = list()
for(i in 1:length(levels(as.factor(motu_siteavg2$Location)))){
  df=spread(motu_siteavg2[motu_siteavg2$Location==levels(as.factor(motu_siteavg2$Location))[i],-2],key=MOTU,value=RRA,fill=0)
  rels = as.data.frame(distance(df[,-1],method="jaccard"))
  rownames(rels)=df$Species
  names(rels)=df$Species
  print(rels)
}

motu_siteavg2$sp_loc=paste(motu_siteavg2$Species,motu_siteavg2$Location,sep="_")
new_net = graph_from_data_frame(motu_siteavg2[,c(5,3,4,1,2)],directed=F)

#V(new_net)$label=c(V(new_net)$name[1:42],rep("",135))
V(new_net)$label=c("Gor","Gor","Gor","Hlu","Mpa","Ser","Hlu","Hwa","Kaf","Mpa","Nia","Ser","Gor","Hlu","Hwa", "Kaf","Kru","Mpa","Nia","Ser","Kaf","Kru","Kaf","Nia","Nyi","Hlu","Hwa","Kaf","Mpa","Nia","Mpa",
                   "Mpa","Ser","Gor","Nyi","Kru","Hlu","Hwa","Nyi","Nia","Hwa","Nia",rep("",384))
V(new_net)$type=c(rep("TRUE",42),rep("FALSE",384))
V(new_net)$size=ifelse(V(new_net)$type=="TRUE",8,3)
V(new_net)$color = c(rep("darkorchid1",1),rep("cyan2",1),rep("green3",4),rep("darkorchid1",6), rep("dodgerblue",8), rep("cyan2",2),rep("green3",3),rep("greenyellow",5), rep("cyan2",1), rep("deeppink2",2), rep("greenyellow",2), rep("deeppink2",5), rep("cyan2",2), rep("gray70",384))
V(new_net)$frame.color=NA
V(new_net)$label.color="gray10"
V(new_net)$label.family="sans serif"
V(new_net)$label.dist=0

edge.start <- ends(new_net, es=E(new_net), names=F)[,1]
edge.col <- V(new_net)$color[edge.start]

LO=layout_as_bipartite(new_net)
plot(new_net,layout=layout_nicely)


```